<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Banco Nacional de Altaria | Mesa del Altar en tiempo real</title>
<meta name="description" content="Consulta el valor oficial del Altar y los principales indicadores macroeconomicos de Altaria en tiempo real.">
<style>
  :root{
    --bg:#f3f5f9;
    --panel:#ffffff;
    --border:#d9e2ef;
    --text:#1b2a3d;
    --muted:#6c7f95;
    --good:#128c61;
    --bad:#d64545;
    --accent:#0b5bd3;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.45}
  header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);box-shadow:0 10px 24px rgba(15,34,67,.08)}
  .wrap{max-width:1180px;margin:0 auto;padding:0 20px}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:18px 0}
  .brand{display:flex;gap:14px;align-items:center}
  .logo{width:46px;height:46px;border-radius:14px;border:1px solid rgba(11,91,208,.24);background:linear-gradient(145deg,#0b5bd3,#0a3f8f);display:grid;place-items:center;box-shadow:0 8px 20px rgba(11,91,208,.25)}
  .logo span{font-weight:700;font-size:20px;color:#ffffff;letter-spacing:.04em}
  h1{margin:0;font-size:19px;font-weight:700}
  .subtitle{font-size:13px;color:var(--muted)}
  .status{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .dot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 0 6px rgba(18,140,97,.12)}
  .tag{padding:5px 12px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted);background:rgba(255,255,255,.7)}
  main{padding:26px 0 64px}
  .grid{display:grid;gap:20px;margin:0;grid-template-columns:repeat(12,1fr)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 16px 30px rgba(15,34,67,.06)}
  .card h3{margin:0 0 14px;font-size:16px;font-weight:600}
  .kpi .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
  .kpi .val{font-size:24px;font-weight:700;margin-top:4px}
  .pos{color:var(--good)}
  .neg{color:var(--bad)}
  canvas{width:100%;height:240px;background:#f7f9fc;border:1px solid var(--border);border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden;font-size:14px}
  thead th{font-size:11px;font-weight:600;color:var(--muted);background:#f0f4fb;text-transform:uppercase;letter-spacing:.08em;padding:12px;text-align:left;border-bottom:1px solid var(--border)}
  tbody td{padding:14px 12px;border-bottom:1px solid var(--border);background:#ffffff}
  tbody tr:last-child td{border-bottom:none}
  tbody tr:nth-child(even) td{background:#f9fbff}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  button{background:linear-gradient(145deg,#0b5bd3,#0a46a0);color:#ffffff;border:1px solid rgba(11,91,208,.35);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;font-size:13px;letter-spacing:.01em;transition:box-shadow .2s ease,transform .2s ease}
  button:hover{box-shadow:0 10px 18px rgba(11,91,208,.18);transform:translateY(-1px)}
  .ticker{overflow:hidden;white-space:nowrap;border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:#ffffff}
  .ticker-inner{display:inline-block;padding:10px 0;animation:ticker 36s linear infinite}
  .tick{display:inline-flex;align-items:center;gap:8px;margin-right:32px;color:var(--muted);font-size:13px}
  .tick::before{content:"|";color:var(--accent);font-size:12px;line-height:1}
  @keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
  .note{font-size:13px;color:var(--muted);margin-top:16px}
  .flex{display:flex;gap:20px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  .admin-trigger{background:none;border:1px solid transparent;color:var(--muted);font-size:11px;letter-spacing:.12em;text-transform:uppercase;padding:6px 10px;border-radius:999px;cursor:pointer;transition:color .2s ease,border-color .2s ease}
  .admin-trigger:hover{color:var(--accent);border-color:var(--border)}
  .admin-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(9,16,28,.55);backdrop-filter:blur(8px);z-index:200}
  .admin-overlay[hidden]{display:none}
  .admin-dialog{width:100%;max-width:380px;background:var(--panel);border-radius:18px;border:1px solid var(--border);box-shadow:0 28px 60px rgba(15,34,67,.25);padding:24px;position:relative}
  .admin-dialog h4{margin:0 0 14px;font-size:16px;font-weight:600}
  .admin-dialog p{margin:0 0 16px;font-size:13px;color:var(--muted)}
  .admin-close{position:absolute;top:12px;right:12px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}
  .admin-form{display:flex;flex-direction:column;gap:12px}
  .admin-form label{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--muted)}
  .admin-form input{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px}
  .admin-form small{font-size:12px;color:var(--muted)}
  .admin-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
  .admin-actions button{min-width:90px;font-size:13px}
  .admin-secondary{background:#f0f4fb;color:var(--muted);border:1px solid var(--border)}
  .admin-secondary:hover{box-shadow:none;transform:none;color:var(--accent)}
  .admin-error{color:var(--bad);font-size:12px;display:none}
  .admin-error[data-visible="true"]{display:block}
  footer{margin-top:40px;color:var(--muted);font-size:12px}
  footer .wrap{padding:24px 20px;border-top:1px solid var(--border)}
  code{background:#eef3fb;padding:2px 4px;border-radius:4px;font-size:12px;color:var(--accent)}
  @media(max-width:1024px){.grid{grid-template-columns:repeat(6,1fr)}.card[style]{grid-column:auto!important}}
  @media(max-width:720px){.topbar{flex-direction:column;align-items:flex-start;gap:14px}.grid{grid-template-columns:repeat(1,1fr)}main{padding:20px 0 48px}}
</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div class="brand">
      <div class="logo"><span>ALT</span></div>
      <div>
        <h1>Banco Nacional de Altaria</h1>
        <div class="subtitle">Mesa del Altar - Seguimiento oficial en tiempo real</div>
      </div>
    </div>
    <div class="status">
      <div class="dot" id="live-dot" title="Conectado a la red interbancaria"></div>
      <span class="tag" id="clock">--</span>
      <span class="tag">Sesion: <span id="session">Abierta</span></span>
      <button type="button" class="admin-trigger" id="admin-trigger" title="Acceso interno">SYS</button>
    </div>
  </div>
  <div class="ticker"><div class="ticker-inner" id="ticker"></div></div>
</header>

<main>
  <div class="wrap">
    <section class="grid">
      <div class="card" style="grid-column: span 8;">
        <h3>ALT / EUR &mdash; Cotizaci&oacute;n intrad&iacute;a</h3>
        <div class="flex">
          <div class="kpi"><div class="label">&Uacute;ltimo</div><div class="val" id="last">--</div></div>
          <div class="kpi"><div class="label">Variaci&oacute;n 24h</div><div class="val" id="chg">--</div></div>
          <div class="kpi"><div class="label">M&aacute;x / M&iacute;n (d&iacute;a)</div><div class="val" id="hi-lo">--</div></div>
          <div class="kpi"><div class="label">Actualizado</div><div class="val" id="asof">--</div></div>
        </div>
        <canvas id="chart"></canvas>
        <div class="note">Serie de referencia publicada por la mesa de dinero del BNA. Intervalo programado: cada 10 minutos (en los minutos 00, 10, 20...).</div>
      </div>

      <div class="card" style="grid-column: span 4;">
        <h3>Indicadores macro nacionales</h3>
        <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:14px">
          <div class="kpi"><div class="label">Inflaci&oacute;n</div><div class="val" id="infl">--</div></div>
          <div class="kpi"><div class="label">PIB (a/a)</div><div class="val" id="gdp">--</div></div>
          <div class="kpi"><div class="label">Desempleo</div><div class="val" id="unemp">--</div></div>
          <div class="kpi"><div class="label">Reservas de oro</div><div class="val" id="gold">--</div></div>
        </div>
        <div class="note">Datos preliminares de cierre diario. Para operaciones mayoristas contactar a su oficial BNA.</div>
        <div class="controls">
          <button id="btn-pause">Suspender flujo</button>
          <button id="btn-step">Actualizar ahora</button>
          <button id="btn-day">Registrar cierre</button>
          <button id="btn-reset">Restablecer serie</button>
          <button id="btn-export">Exportar CSV</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:24px">
      <h3>Tipos de cambio del Altar (ALT) - Pares principales</h3>
      <table>
        <thead><tr><th>Par</th><th>Precio</th><th>Variaci&oacute;n</th><th>Sesgo</th></tr></thead>
        <tbody id="fx"></tbody>
      </table>
      <div class="note">Precios expresados en ALT. Las variaciones se calculan respecto al nivel observado en la &uacute;ltima toma de datos.</div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap">Banco Nacional de Altaria &copy; Mesa del Altar. Informaci&oacute;n referencial generada desde el entorno del usuario; verifique antes de cursar instrucciones.</div>
</footer>

<div class="admin-overlay" id="admin-overlay" hidden>
  <div class="admin-dialog">
    <button type="button" class="admin-close" id="admin-close" aria-label="Cerrar acceso interno">&times;</button>
    <div id="admin-login">
      <h4>Acceso interno</h4>
      <p>Identifique la clave operativa para continuar.</p>
      <form class="admin-form" id="admin-login-form">
        <label for="admin-password">Clave</label>
        <input type="password" id="admin-password" autocomplete="off" inputmode="numeric" pattern="[0-9]*" required>
        <span class="admin-error" id="admin-login-error">Clave incorrecta.</span>
        <div class="admin-actions">
          <button type="button" class="admin-secondary" data-close>Cancelar</button>
          <button type="submit">Ingresar</button>
        </div>
      </form>
    </div>
    <div id="admin-panel" hidden>
      <h4>Panel de ajuste</h4>
      <p>Actualice el valor de referencia ALT/EUR. Las dem&aacute;s divisas se ajustan de forma proporcional.</p>
      <form class="admin-form" id="admin-panel-form">
        <label for="admin-alt-eur">ALT / EUR</label>
        <input type="number" id="admin-alt-eur" step="0.01" min="0.01" required>
        <small>Se guardar&aacute; como nueva base operativa y se notificar&aacute; al resto de m&oacute;dulos.</small>
        <span class="admin-error" id="admin-panel-error">Ingrese un valor v&aacute;lido mayor que cero.</span>
        <div class="admin-actions">
          <button type="button" class="admin-secondary" data-close>Cerrar</button>
          <button type="submit">Aplicar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const CFG = {
  base: { EUR: 2.00, USD: 2.10, GBP: 1.75, JPY: 315.0, MXN: 38.7 },
  dailyVolPct:  { EUR: 0.10, USD: 0.45, GBP: 0.35, JPY: 0.50, MXN: 0.70 },
  bandsPct:     { EUR: [-1,1], USD: [-5,5], GBP: [-4,4], JPY: [-6,6], MXN: [-8,8] },
  ind: {
    infl: { base: 1.8, vol: 0.03, bands: [0.0, 3.0] },
    gdp:  { base: 6.2, vol: 0.10, bands: [2.0, 8.0] },
    unemp:{ base: 2.4, vol: 0.03, bands: [1.0, 4.0] },
    gold: { base: 5000, vol: 1.0, bands: [4800, 5200] }
  },
  canvasH: 240,
  historyDays: 120,
  newsPool: [
    "Mesa de Dinero mantiene la referencia ALT/EUR en 2.00",
    "Reservas de oro estables segun reporte trimestral",
    "Altaria firma acuerdo tecnologico con Espana para soluciones de pago",
    "Exportaciones de energia solar suben 4.1 por ciento interanual",
    "Desempleo urbano en 2.4 por ciento, minimo historico",
    "Produccion agroecologica supera la meta del trimestre",
    "Semana del Sol impulsa el turismo cultural en Altaria"
  ]
};
const KEY = "ALTARIA_LIVE_SIM_V1";
const FX_KEYS = Object.keys(CFG.base);

function todayStr(d=new Date()){const y=d.getFullYear(),m=(d.getMonth()+1+"").padStart(2,"0"),dd=(d.getDate()+"").padStart(2,"0");return `${y}-${m}-${dd}`;}
function dateTimeStr(d){return `${todayStr(d)} ${d.toTimeString().slice(0,8)}`;}
function clamp(v,a,b){return Math.min(b,Math.max(a,v));}
function rnd(a,b){return a+Math.random()*(b-a);}
function isWeekend(d=new Date()){const w=d.getDay();return w===0||w===6;}
function slotFloor(date=new Date()){
  const d=new Date(date);
  d.setSeconds(0,0);
  const minutes=d.getMinutes();
  d.setMinutes(minutes - (minutes%10));
  return d;
}
function slotKey(date=new Date()){
  const slot=slotFloor(date);
  return `${todayStr(slot)}T${slot.toTimeString().slice(0,5)}`;
}
function slotKeyToDate(key){
  if(!key) return slotFloor(new Date());
  return new Date(`${key}:00`);
}
function nextSlotDate(fromDate=new Date()){
  const next=slotFloor(fromDate);
  next.setMinutes(next.getMinutes()+10);
  return next;
}
function resolveBase(st,k){
  return st.base && typeof st.base[k]==="number"?st.base[k]:CFG.base[k];
}
function roundFx(k,val){
  const decimals=k==="JPY"?1:2;
  return parseFloat(val.toFixed(decimals));
}

function initialState(){
  const now=new Date(), date=todayStr(now), base={...CFG.base}, fx={...base};
  const slot=slotKey(now);
  const ind={infl:CFG.ind.infl.base,gdp:CFG.ind.gdp.base,unemp:CFG.ind.unemp.base,gold:CFG.ind.gold.base};
  const ohlc=[{t:dateTimeStr(now),o:fx.EUR,h:fx.EUR,l:fx.EUR,c:fx.EUR}];
  return {date,fx,base,ind,ohlc,history:[[date,fx.EUR]],paused:false,lastSlot:slot};
}
function loadState(){
  try{const j=localStorage.getItem(KEY);if(!j){const s=initialState();localStorage.setItem(KEY,JSON.stringify(s));return s;}return JSON.parse(j);}
  catch{const s=initialState();localStorage.setItem(KEY,JSON.stringify(s));return s;}
}
function addOneDay(iso){const d=new Date(iso+"T00:00:00");d.setDate(d.getDate()+1);return todayStr(d);}
function ensureUpToDate(st){
  if(!st.base) st.base={...CFG.base};
  const t=todayStr();
  if(st.date!==t){
    while(st.date!==t){
      const target=resolveBase(st,"EUR");
      st.fx.EUR = roundFx("EUR", st.fx.EUR + (target - st.fx.EUR)*0.05);
      st.date=addOneDay(st.date);
      st.history.push([st.date,st.fx.EUR]);
    }
    st.ohlc=[{t:dateTimeStr(new Date()),o:st.fx.EUR,h:st.fx.EUR,l:st.fx.EUR,c:st.fx.EUR}];
  }
  if(!st.lastSlot) st.lastSlot=slotKey(new Date());
  return st;
}
let ST = ensureUpToDate(loadState());
function persist(){localStorage.setItem(KEY,JSON.stringify(ST));}

function applySlotUpdate(slotDate=new Date(), {silent=false}={}){
  const calm = isWeekend(slotDate)?0.5:1.0;
  const stepsPerDay = 24*6;
  for(const k of Object.keys(ST.fx)){
    const base=resolveBase(ST,k), [lo,hi]=CFG.bandsPct[k], dvol=CFG.dailyVolPct[k]*calm;
    const stepShare = dvol/stepsPerDay;
    let next = ST.fx[k]*(1 + ((Math.random()-0.5)*stepShare)/100);
    next += (base - next)*0.02;
    next = clamp(next, base*(1+lo/100), base*(1+hi/100));
    ST.fx[k] = roundFx(k,next);
  }
  const last=ST.ohlc[ST.ohlc.length-1];
  last.c=ST.fx.EUR;
  last.h=Math.max(last.h,ST.fx.EUR);
  last.l=Math.min(last.l,ST.fx.EUR);
  last.t=dateTimeStr(slotDate);
  ST.lastSlot=slotKey(slotDate);
  persist();
  if(!silent){render();}
}
function applyAdminOverride(newAltEur){
  if(!ST.base) ST.base={...CFG.base};
  const prevBases={};
  for(const k of FX_KEYS){ prevBases[k]=resolveBase(ST,k); }
  const previousValue=ST.fx.EUR>0?ST.fx.EUR:prevBases.EUR;
  const ratio = previousValue>0?newAltEur/previousValue:1;
  for(const k of FX_KEYS){
    if(k==="EUR"){
      ST.fx[k]=roundFx(k,newAltEur);
      ST.base[k]=roundFx(k,newAltEur);
    }else{
      ST.fx[k]=roundFx(k, ST.fx[k]*ratio);
      ST.base[k]=roundFx(k, prevBases[k]*ratio);
    }
  }
  const now=new Date();
  const last=ST.ohlc[ST.ohlc.length-1];
  last.c=ST.fx.EUR;
  last.h=Math.max(last.h,ST.fx.EUR);
  last.l=Math.min(last.l,ST.fx.EUR);
  last.t=dateTimeStr(now);
  if(ST.history.length){
    const tail=ST.history[ST.history.length-1];
    if(tail[0]===ST.date){ tail[1]=ST.fx.EUR; }
    else { ST.history.push([ST.date,ST.fx.EUR]); }
  }else{
    ST.history.push([ST.date,ST.fx.EUR]);
  }
  ST.lastSlot=slotKey(now);
  persist();
  render();
  if(slotTimer){clearTimeout(slotTimer);slotTimer=null;}
  scheduleNextSlot();
}
function closeDay(){
  const d=new Date(ST.date+"T00:00:00"); d.setDate(d.getDate()+1); const newDate=todayStr(d);
  for(const k of Object.keys(ST.ind)){
    const cfg=CFG.ind[k]; let n=ST.ind[k]*(1+((Math.random()-0.5)*cfg.vol)/100);
    ST.ind[k]=parseFloat(clamp(n,cfg.bands[0],cfg.bands[1]).toFixed(k==="gold"?0:1));
  }
  ST.date=newDate; ST.history.push([newDate,ST.fx.EUR]);
  while(ST.history.length>CFG.historyDays) ST.history.shift();
  ST.ohlc.push({t:dateTimeStr(d),o:ST.fx.EUR,h:ST.fx.EUR,l:ST.fx.EUR,c:ST.fx.EUR});
  ST.lastSlot=slotKey(d);
  persist(); render(); scheduleNextSlot();
}

function render(){
  document.getElementById("clock").textContent=new Date().toLocaleString();
  document.getElementById("session").textContent=isWeekend()?"Cerrada (fin de semana)":"Abierta";

  const last=ST.fx.EUR; const prev=ST.history.length>1?ST.history[ST.history.length-2][1]:last;
  const chg=((last-prev)/prev)*100; const hi=ST.ohlc[ST.ohlc.length-1].h; const lo=ST.ohlc[ST.ohlc.length-1].l;
  document.getElementById("last").textContent=`ALT ${last.toFixed(2)}`;
  const chgEl=document.getElementById("chg"); chgEl.textContent=`${chg>=0?"+":""}${chg.toFixed(2)}%`; chgEl.className="val "+(chg>=0?"pos":"neg");
  document.getElementById("hi-lo").textContent=`ALT ${hi.toFixed(2)} / ALT ${lo.toFixed(2)}`;
  document.getElementById("asof").textContent=ST.ohlc[ST.ohlc.length-1].t.replace(" ","  |  ");

  const tbody=document.getElementById("fx"); tbody.innerHTML="";
  for(const k of Object.keys(ST.fx)){
    const approx = k==="EUR"?chg:((Math.random()-0.5)*0.6);
    const price = ST.fx[k].toFixed(k==="JPY"?1:2);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>ALT / ${k}</td>
                  <td><strong>ALT ${price}</strong></td>
                  <td class="${approx>=0?'pos':'neg'}">${approx>=0?'+':''}${approx.toFixed(2)}%</td>
                  <td>${approx>0.05?'Firme':(approx<-0.05?'Debil':'Neutral')}</td>`;
    tbody.appendChild(tr);
  }

  const fmtPct=v=>(v>0?"+":"")+v.toFixed(1)+" %";
  document.getElementById("infl").textContent=ST.ind.infl.toFixed(1)+" %";
  document.getElementById("gdp").textContent=fmtPct(ST.ind.gdp);
  document.getElementById("unemp").textContent=ST.ind.unemp.toFixed(1)+" %";
  document.getElementById("gold").textContent=ST.ind.gold.toFixed(0)+" t";

  drawChart(ST.ohlc); renderTicker();
}
function drawChart(ohlc){
  const c=document.getElementById("chart"), ctx=c.getContext("2d"), DPR=devicePixelRatio||1;
  const W=c.width=c.clientWidth*DPR, H=c.height=240*DPR;
  ctx.clearRect(0,0,W,H);
  const vals=ohlc.map(x=>x.c), min=Math.min(...vals), max=Math.max(...vals), pad=10*DPR;
  const x=i=>pad+(i/(ohlc.length-1||1))*(W-2*pad), y=v=>H-pad-((v-min)/(max-min||1))*(H-2*pad);
  ctx.beginPath(); ohlc.forEach((p,i)=>{ const X=x(i),Y=y(p.c); i?ctx.lineTo(X,Y):ctx.moveTo(X,Y); });
  ctx.lineTo(W-pad,H-pad); ctx.lineTo(pad,H-pad); ctx.closePath();
  const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,"rgba(11,91,208,.18)"); g.addColorStop(1,"rgba(11,91,208,0)");
  ctx.fillStyle=g; ctx.fill();
  ctx.beginPath(); ohlc.forEach((p,i)=>{ const X=x(i),Y=y(p.c); i?ctx.lineTo(X,Y):ctx.moveTo(X,Y); });
  ctx.lineWidth=2*DPR; ctx.strokeStyle="#0b5bd3"; ctx.stroke();
  const hi=Math.max(...ohlc.map(o=>o.h)), lo=Math.min(...ohlc.map(o=>o.l));
  ctx.setLineDash([6*DPR,6*DPR]); ctx.strokeStyle="rgba(18,140,97,.35)";
  ctx.beginPath(); ctx.moveTo(pad,y(hi)); ctx.lineTo(W-pad,y(hi)); ctx.stroke();
  ctx.strokeStyle="rgba(214,69,69,.35)";
  ctx.beginPath(); ctx.moveTo(pad,y(lo)); ctx.lineTo(W-pad,y(lo)); ctx.stroke();
  ctx.setLineDash([]);
}
function renderTicker(){
  const el=document.getElementById("ticker"); if(el.dataset.ready) return;
  const items=[]; for(const n of CFG.newsPool){ items.push(`<span class="tick">${n}</span>`); }
  el.innerHTML=items.join("")+items.join(""); el.dataset.ready="1";
}

function catchUpSlots(){
  const nowSlotDate=slotFloor(new Date());
  let lastSlotDate=slotKeyToDate(ST.lastSlot);
  if(lastSlotDate>nowSlotDate){
    ST.lastSlot=slotKey(nowSlotDate);
    persist();
    return false;
  }
  let updated=false;
  while(lastSlotDate<nowSlotDate){
    lastSlotDate=nextSlotDate(lastSlotDate);
    applySlotUpdate(lastSlotDate,{silent:true});
    updated=true;
  }
  return updated;
}

let slotTimer=null;
function scheduleNextSlot(){
  if(slotTimer){clearTimeout(slotTimer);slotTimer=null;}
  if(ST.paused) return;
  const now=new Date();
  const target=nextSlotDate(now);
  const delay=target.getTime()-now.getTime();
  slotTimer=setTimeout(()=>simulateLatency(()=>{applySlotUpdate(target); scheduleNextSlot();}), delay);
}
function simulateLatency(cb){
  const ms=rnd(120,520), dot=document.getElementById("live-dot");
  dot.style.opacity=".5";
  setTimeout(()=>{dot.style.opacity="1"; cb();}, ms);
}

const ADMIN_PIN="1699";
const adminTrigger=document.getElementById("admin-trigger");
const adminOverlay=document.getElementById("admin-overlay");
const adminLoginSection=document.getElementById("admin-login");
const adminPanelSection=document.getElementById("admin-panel");
const adminLoginForm=document.getElementById("admin-login-form");
const adminPanelForm=document.getElementById("admin-panel-form");
const adminPasswordInput=document.getElementById("admin-password");
const adminAltEurInput=document.getElementById("admin-alt-eur");
const adminLoginError=document.getElementById("admin-login-error");
const adminPanelError=document.getElementById("admin-panel-error");

function openAdminOverlay(){
  adminOverlay.hidden=false;
  adminLoginSection.hidden=false;
  adminPanelSection.hidden=true;
  adminPasswordInput.value="";
  adminAltEurInput.value="";
  adminLoginError.dataset.visible="false";
  adminPanelError.dataset.visible="false";
  setTimeout(()=>adminPasswordInput.focus(),0);
}
function closeAdminOverlay(){
  adminOverlay.hidden=true;
  adminPasswordInput.value="";
  adminAltEurInput.value="";
  adminLoginError.dataset.visible="false";
  adminPanelError.dataset.visible="false";
}
adminTrigger.addEventListener("click", openAdminOverlay);
document.getElementById("admin-close").addEventListener("click", closeAdminOverlay);
adminOverlay.querySelectorAll("[data-close]").forEach(btn=>btn.addEventListener("click", closeAdminOverlay));
adminOverlay.addEventListener("click", e=>{ if(e.target===adminOverlay){ closeAdminOverlay(); }});
adminLoginForm.addEventListener("submit", e=>{
  e.preventDefault();
  if(adminPasswordInput.value.trim()===ADMIN_PIN){
    adminLoginError.dataset.visible="false";
    adminLoginSection.hidden=true;
    adminPanelSection.hidden=false;
    adminAltEurInput.value=resolveBase(ST,"EUR").toFixed(2);
    setTimeout(()=>adminAltEurInput.focus(),0);
  }else{
    adminLoginError.dataset.visible="true";
    adminPasswordInput.focus();
    adminPasswordInput.select();
  }
});
adminPanelForm.addEventListener("submit", e=>{
  e.preventDefault();
  const newValue=parseFloat(adminAltEurInput.value);
  if(!Number.isFinite(newValue)||newValue<=0){
    adminPanelError.dataset.visible="true";
    adminAltEurInput.focus();
    return;
  }
  adminPanelError.dataset.visible="false";
  applyAdminOverride(newValue);
  closeAdminOverlay();
});
document.addEventListener("keydown", e=>{
  if(e.key==="Escape" && !adminOverlay.hidden){ closeAdminOverlay(); }
});

document.getElementById("btn-pause").addEventListener("click", ()=>{
  ST.paused=!ST.paused;
  if(slotTimer){clearTimeout(slotTimer);slotTimer=null;}
  if(!ST.paused){scheduleNextSlot();}
  document.getElementById("btn-pause").textContent=ST.paused?"Reanudar flujo":"Suspender flujo";
});
document.getElementById("btn-step").addEventListener("click", ()=>{
  simulateLatency(()=>{
    if(slotTimer){clearTimeout(slotTimer);slotTimer=null;}
    const lastSlotDate=slotKeyToDate(ST.lastSlot);
    const currentSlotDate=slotFloor(new Date());
    const target=currentSlotDate>lastSlotDate?currentSlotDate:nextSlotDate(lastSlotDate);
    applySlotUpdate(target);
    scheduleNextSlot();
  });
});
document.getElementById("btn-day").addEventListener("click", ()=>simulateLatency(closeDay));
document.getElementById("btn-reset").addEventListener("click", ()=>{
  if(confirm("Restablecer la serie de datos?")){
    if(slotTimer){clearTimeout(slotTimer);slotTimer=null;}
    ST=initialState();
    persist();
    catchUpSlots();
    render();
    scheduleNextSlot();
  }
});
document.getElementById("btn-export").addEventListener("click", ()=>{
  const rows=[["fecha_hora","ALT_EUR_last","ALT_EUR_high","ALT_EUR_low","inflacion","pib","desempleo","oro"]];
  ST.ohlc.forEach(o=>rows.push([o.t,o.c,o.h,o.l,ST.ind.infl,ST.ind.gdp,ST.ind.unemp,ST.ind.gold]));
  const csv=rows.map(r=>r.join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="altar_panel_intradia.csv"; a.click(); URL.revokeObjectURL(url);
});
setInterval(()=>{document.getElementById("clock").textContent=new Date().toLocaleString();},1000);

catchUpSlots();
render();
scheduleNextSlot();
</script>
</body>
</html>
